<project name="Helianthus.bolanderi" default="beta">
	<property name="PROJECT_NAME" value="Helianthus.annuus" />
	<property name="PROJECT_NAME_SHORT" value="annuus" />
	<property name="PROJECT_AUTHOR" value="project.helianthus" />
	<property name="PROJECT_DESCRIPTION" value="Turn HKGolden Forum into a freaking awesome web app!" />
	<property name="PROJECT_URL" value="http://github.com/helianthus/Helianthus.annuus" />
	<property name="PROJECT_TARGET_MATCH" value="http://*.hkgolden.com/*" />
	<property name="PROJECT_TARGET_INCLUDE" value="http://forum*.hkgolden.com/*" />
	<property name="PROJECT_TARGET_PRIVOXY" value="forum*.hkgolden.com/(?:$|(?:[^\/]+\/)*[a-z]+?\.(?:aspx|html))" />
	<property name="PROJECT_TARGET_REGEX" value="^http:\/\/forum\d+\.hkgolden\.com\/(?:$|(?:[^\/]+\/)*[a-z]+?\.(?:aspx|html))" />
	<property name="PROJECT_LICENSE" value="Licensed under the GPL license." />
	<property name="PROJECT_LICENSE_URL" value="http://www.gnu.org/licenses/gpl.html" />

	<tstamp>
		<format property="PROJECT_BUILD_TIME" pattern="yyyy-MM-dd HH:mm:ss" />
	</tstamp><tstamp>
		<format property="PROJECT_BUILD_YEAR" pattern="yyyy" />
	</tstamp>

	<property name="dist_parent_dir" value="dist" />
	<property name="build_dir" value="build" />
	<property name="tools_dir" value="tools" />
	<property name="key_file" value="key.pem" />
	<property name="dist_url" value="http://helianthus-annuus.googlecode.com/svn/dist" />

	<!--** test **-->
	<target name="test" depends="_build,_build_cont" />

	<!--** build **-->
	<target name="build" depends="_build,_minify,_build_cont" />

	<!--** beta **-->
	<target name="beta" depends="_beta, build, _dist">
		<copy file="src/version.js" todir="${dist_parent_dir}">
			<filterset>
				<filter token="PROJECT_VERSION_BETA" value="${PROJECT_VERSION}" />
				<filter token="PROJECT_VERSION_STABLE" value="${PROJECT_VERSION_STABLE}" />
			</filterset>
		</copy>

		<echo>Version: ${PROJECT_VERSION}</echo>
	</target>

	<!--** stable **-->
	<target name="stable" depends="_stable, build, _dist">
		<!-- duplicate as beta -->
		<copy todir="${dist_parent_dir}/beta">
		 <fileset dir="${dist_parent_dir}/stable" includes="/" />
		</copy>

		<!-- version.js -->
		<copy file="src/version.js" todir="${dist_parent_dir}">
			<filterset>
				<filter token="PROJECT_VERSION_BETA" value="${PROJECT_VERSION}" />
				<filter token="PROJECT_VERSION_STABLE" value="${PROJECT_VERSION}" />
			</filterset>
		</copy>

		<!-- build.ini -->
		<propertyfile file="build.ini">
			<entry key="PROJECT_VERSION_STABLE" value="${PROJECT_VERSION}" />
			<entry key="RELEASE_VERSION" type="int" operation="+" value="1" />
		</propertyfile>

		<echo>Version: ${PROJECT_VERSION}</echo>
	</target>

	<!--** internals **-->

	<tempfile property="content_file" destdir="${build_dir}" suffix=".js" deleteonexit="true" />
	<tempfile property="temp_file" destdir="${build_dir}" suffix=".js" deleteonexit="true" />

	<target name="_build" depends="_beta">
		<propertyfile file="build.ini">
			<entry key="MAIN_VERSION" default="0.0" />
			<entry key="RELEASE_VERSION" default="0" />
			<entry key="BUILD_NUMBER" default="0" type="int" pattern="####" operation="+" />
		</propertyfile>

		<property file="build.ini" />

		<property name="PROJECT_VERSION" value="${MAIN_VERSION}.${RELEASE_VERSION}.${BUILD_NUMBER}" />

		<delete dir="${build_dir}" />
		<mkdir dir="${build_dir}" />

		<!-- CONTENT -->
		<concat destfile="${content_file}" fixlastline="true" encoding="UTF-8">
			<filelist dir="src/script">
				<file name="opera/opera9.js" />
				<file name="opera/rubbish.js" />
				<file name="kernel/lib/jquery.js" />
			</filelist>
			<fileset dir="src/script">
				<include name="kernel/**/*.js" />
				<include name="modules/**/*.js" />
				<exclude name="kernel/lib/jquery.js" />
			</fileset>
		</concat>

		<!-- escaping has to be done here to avoid text being splitted -->
		<loadfile property="CONTENT" srcfile="${content_file}" encoding="UTF-8">
			<filterchain>
				<escapeunicode />
			</filterchain>
		</loadfile>

		<!-- js -->
		<copy file="src/script/bolanderi.js" tofile="${build_dir}/${PROJECT_NAME_SHORT}.js">
			<filterchain>
				<concatfilter prepend="src/header.js" />
			</filterchain>
			<filterset begintoken="/*@" endtoken="@*/">
				<filter token="CONTENT" value="${CONTENT}" />
			</filterset>
		</copy>
	</target>

	<taskdef name="jscomp" classname="com.google.javascript.jscomp.ant.CompileTask" classpath="${tools_dir}/closurecompiler/compiler.jar" />
	<target name="_minify">
		<!-- js(raw) -->
		<move file="${build_dir}/${PROJECT_NAME_SHORT}.js" tofile="${build_dir}/${PROJECT_NAME_SHORT}-raw.js" />

		<!-- js(minified) -->
		<jscomp compilationLevel="simple" warning="quiet" debug="false" output="${temp_file}">
			<sources dir="${build_dir}">
				<file name="${PROJECT_NAME_SHORT}-raw.js" />
			</sources>
		</jscomp>

		<copy file="${temp_file}" tofile="${build_dir}/${PROJECT_NAME_SHORT}.js">
			<filterchain>
				<concatfilter prepend="src/header.js" />
			</filterchain>
		</copy>
	</target>

	<target name="_build_cont">
		<!-- user.js -->
		<exec executable="${tools_dir}/base64/base64.exe">
			<arg line="-e ${build_dir}/${PROJECT_NAME_SHORT}.js ${temp_file}" />
		</exec>

		<loadfile property="ENCODED_CONTENT" srcfile="${temp_file}">
			<filterchain>
				<striplinebreaks />
			</filterchain>
		</loadfile>

		<copy file="src/user/bolanderi.user.js" todir="${build_dir}/user">
			<filterchain>
				<concatfilter prepend="src/header.js" />
			</filterchain>
			<filterset>
				<filter token="ENCODED_CONTENT" value="${ENCODED_CONTENT}" />
			</filterset>
		</copy>

		<!-- xpi -->
		<copy todir="${build_dir}/xpi">
			<fileset dir="src/xpi" />
		</copy>
		<copy file="${build_dir}/${PROJECT_NAME_SHORT}.js" todir="${build_dir}/xpi/content/" />

		<!-- m2f -->
		<copy file="src/m2f/bolanderi.xml" todir="${build_dir}/m2f" />
		<copy file="${build_dir}/${PROJECT_NAME_SHORT}.js" todir="${build_dir}/m2f/${PROJECT_NAME_SHORT}/scripts" />

		<!-- crx -->
		<copy todir="${build_dir}/crx">
			<fileset dir="src/crx" />
			<fileset file="${build_dir}/${PROJECT_NAME_SHORT}.js" />
		</copy>

		<!-- privoxy -->
		<copy todir="${build_dir}/privoxy">
			<fileset dir="src/privoxy" />
		</copy>

		<!-- rename files -->
		<move todir="${build_dir}">
			<filtermapper>
				<replacestring from="bolanderi" to="${PROJECT_NAME_SHORT}" />
			</filtermapper>
			<fileset dir="${build_dir}" includes="**/bolanderi.*" />
		</move>

		<!-- replace tokens -->
		<replace dir="${build_dir}">
			<include name="**/*.action" />
			<include name="**/*.css" />
			<include name="**/*.filter" />
			<include name="**/*.js" />
			<include name="**/*.json" />
			<include name="**/*.manifest" />
			<include name="**/*.rdf" />
			<include name="**/*.xml" />
			<include name="**/*.xul" />

			<replacefilter token="@PROJECT_AUTHOR@" value="${PROJECT_AUTHOR}" />
			<replacefilter token="@PROJECT_BUILD_TIME@" value="${PROJECT_BUILD_TIME}" />
			<replacefilter token="@PROJECT_BUILD_YEAR@" value="${PROJECT_BUILD_YEAR}" />
			<replacefilter token="@PROJECT_DESCRIPTION@" value="${PROJECT_DESCRIPTION}" />
			<replacefilter token="@PROJECT_FILE_URL@" value="${PROJECT_FILE_URL}" />
			<replacefilter token="@PROJECT_LICENSE@" value="${PROJECT_LICENSE}" />
			<replacefilter token="@PROJECT_LICENSE_URL@" value="${PROJECT_LICENSE_URL}" />
			<replacefilter token="@PROJECT_NAME@" value="${PROJECT_NAME}" />
			<replacefilter token="@PROJECT_NAME_SHORT@" value="${PROJECT_NAME_SHORT}" />
			<replacefilter token="@PROJECT_TARGET_INCLUDE@" value="${PROJECT_TARGET_INCLUDE}" />
			<replacefilter token="@PROJECT_TARGET_MATCH@" value="${PROJECT_TARGET_MATCH}" />
			<replacefilter token="@PROJECT_TARGET_PRIVOXY@" value="${PROJECT_TARGET_PRIVOXY}" />
			<replacefilter token="@PROJECT_TARGET_REGEX@" value="${PROJECT_TARGET_REGEX}" />
			<replacefilter token="@PROJECT_URL@" value="${PROJECT_URL}" />
			<replacefilter token="@PROJECT_VERSION@" value="${PROJECT_VERSION}" />
		</replace>
	</target>

	<target name="_dist">
		<delete dir="${dist_dir}" />
		<mkdir dir="${dist_dir}" />

		<!-- scripts -->
		<copy todir="${dist_dir}">
			<fileset dir="${build_dir}" includes="${PROJECT_NAME_SHORT}.js" />
			<fileset dir="${build_dir}/user" includes="${PROJECT_NAME_SHORT}.user.js" />
		</copy>

		<!-- crx -->
		<exec executable="cmd">
			<!-- http://github.com/Constellation/crxmake -->
			<arg value="/C crxmake --pack-extension=${build_dir}/crx --pack-extension-key=${key_file} --extension-out=${dist_dir}/${PROJECT_NAME_SHORT}.crx" />
		</exec>

		<!-- xpi -->
		<mkdir dir="${build_dir}/xpi_package/chrome" />

		<zip destfile="${build_dir}/xpi_package/chrome/${PROJECT_NAME_SHORT}.jar" basedir="${build_dir}/xpi" includes="content/,locale/,skin/" />
		<copy todir="${build_dir}/xpi_package">
			<fileset dir="${build_dir}/xpi" includes="*/" excludes="content/,locale/,skin/" />
		</copy>
		<replaceregexp file="${build_dir}/xpi_package/chrome.manifest" match=" (?=(?:content|locale|skin)/)" replace=" jar:chrome/${PROJECT_NAME_SHORT}.jar!/" flags="g" />

		<zip destfile="${dist_dir}/${PROJECT_NAME_SHORT}.xpi" basedir="${build_dir}/xpi_package" />

		<!-- m2f -->
		<zip destfile="${dist_dir}/${PROJECT_NAME_SHORT}.m2f" basedir="${build_dir}/m2f" />

		<!-- privoxy -->
		<zip destfile="${dist_dir}/${PROJECT_NAME_SHORT}.privoxy.zip" basedir="${build_dir}/privoxy" />
	</target>

	<target name="_stable">
		<property name="dist_dir" value="${dist_parent_dir}/stable" />
		<property name="PROJECT_FILE_URL" value="${dist_url}/stable/${PROJECT_NAME_SHORT}.js" />
	</target>

	<target name="_beta">
		<property name="dist_dir" value="${dist_parent_dir}/beta" />
		<property name="PROJECT_FILE_URL" value="${dist_url}/beta/${PROJECT_NAME_SHORT}.js" />
	</target>
</project>
<project name="Helianthus.annuus" default="test">
	<property name="dist_parent_dir" value="dist" />
	<property name="build_dir" value="build" />
	<property name="tools_dir" value="tools" />
	<property name="key_path" value="../key.pem" />

	<tempfile property="temp" destdir="${build_dir}" suffix=".js" deleteonexit="true" />
	<tempfile property="temp2" destdir="${build_dir}" suffix=".js" deleteonexit="true" />

	<!--** test **-->
	<target name="test" depends="_build,_build_cont" />

	<!--** build **-->
	<target name="build" depends="_build,_minify,_build_cont" />

	<!--** beta **-->
	<target name="beta" depends="_beta, _clean, build, _dist">
		<copy file="src/version.js" tofile="${dist_parent_dir}/an.version.js" overwrite="true" encoding="UTF-8">
			<filterset>
				<filter token="AN_BETA" value="${AN_VERSION}" />
				<filter token="AN_STABLE" value="${AN_VERSION_STABLE}" />
			</filterset>
		</copy>

		<echo>Version: ${AN_VERSION}</echo>
	</target>

	<!--** stable **-->
	<target name="stable" depends="_stable, _clean, build, _dist">
		<!-- duplicate as beta -->
		<copy todir="${dist_parent_dir}/beta">
		 <fileset dir="${dist_parent_dir}/stable" includes="**/*" />
		</copy>

		<!-- version.js -->
		<copy file="src/version.js" tofile="${dist_parent_dir}/an.version.js" overwrite="true" encoding="UTF-8">
			<filterset>
				<filter token="AN_BETA" value="${AN_VERSION}" />
				<filter token="AN_STABLE" value="${AN_VERSION}" />
			</filterset>
		</copy>

		<!-- an.crx.xml
		<copy file="src/crx.xml" tofile="../other/annuus.crx.xml" overwrite="true" encoding="UTF-8">
			<filterchain>
				<expandproperties/>
			</filterchain>
		</copy>
		-->

		<!-- build.ini -->
		<propertyfile file="build.ini">
			<entry key="AN_VERSION_STABLE" value="${AN_VERSION}" />
			<entry key="RELEASE_VERSION" type="int" operation="+" value="1" />
		</propertyfile>

		<echo>Version: ${AN_VERSION}</echo>
	</target>

	<!--** internals **-->

	<target name="_build" depends="_beta">
		<propertyfile file="build.ini">
			<entry key="MAIN_VERSION" default="0.0" />
			<entry key="RELEASE_VERSION" default="0" />
			<entry key="BUILD_NUMBER" default="0" type="int" pattern="####" operation="+" />
		</propertyfile>

		<property file="build.ini" />

		<tstamp>
			<format property="BUILD_TIME" pattern="yyyy-MM-dd HH:mm:ss" />
		</tstamp>
		<property name="AN_VERSION" value="${MAIN_VERSION}.${RELEASE_VERSION}.${BUILD_NUMBER}" />

		<delete dir="${build_dir}" />
		<mkdir dir="${build_dir}" />

		<!-- annuus.js -->
		<concat destfile="${temp}" fixlastline="true" encoding="UTF-8">
			<filterchain>
				<expandproperties/>
			</filterchain>

			<fileset file="src/script/intro.js" />

			<!-- opera -->
			<filelist dir="src/script/opera">
				<file name="opera9.js" />
				<file name="rubbish.js" />
			</filelist>
			<!-- lib -->
			<fileset file="src/script/lib/jquery.js" />
			<fileset file="src/script/lib/jquery.followup.js" />
			<fileset dir="src/script/lib" includes="*.js" excludes="jquery.js,jquery.followup.js" />
			<!-- kernel -->
			<fileset dir="src/script/kernel" includes="*.js" />
			<!-- plugins -->
			<fileset dir="src/script/plugins" includes="*.js" />
			<!-- init -->
			<fileset file="src/script/kernel/init/misc.js" />
			<fileset file="src/script/kernel/init/storage.js" />
			<fileset file="src/script/kernel/init/an.js" />
			<fileset file="src/script/kernel/init/init.js" />

			<fileset file="src/script/outro.js" />
		</concat>

		<concat destfile="${build_dir}/annuus.js" encoding="UTF-8">
			<filterchain>
				<expandproperties/>
			</filterchain>

			<fileset file="src/script/header.js" />
			<fileset file="${temp}" />
		</concat>
	</target>

	<taskdef name="jscomp" classname="com.google.javascript.jscomp.ant.CompileTask" classpath="${tools_dir}/closurecompiler/compiler.jar" />
	<target name="_minify">
		<!-- annuus-raw.js -->
		<move file="${build_dir}/annuus.js" tofile="${build_dir}/annuus-raw.js" />

		<jscomp compilationLevel="simple" warning="quiet" debug="false" output="${temp}">
			<sources dir="${build_dir}">
				<file name="annuus-raw.js"/>
			</sources>
		</jscomp>

		<concat destfile="${build_dir}/annuus.js" encoding="UTF-8">
			<filterchain>
				<expandproperties/>
			</filterchain>

			<fileset file="src/script/header.js" />
			<fileset file="${temp}" />
		</concat>
	</target>

	<target name="_build_cont">
		<!-- annuus.user.js -->
		<exec executable="${tools_dir}/base64/base64.exe">
			<arg line="-e ${temp} ${temp2}" />
		</exec>

		<loadfile property="ENCODED_SCRIPT_CONTENT" srcfile="${temp2}">
			<filterchain>
				<striplinebreaks />
			</filterchain>
		</loadfile>

		<concat destfile="${build_dir}/user/annuus.user.js" fixlastline="true" encoding="UTF-8">
			<filterchain>
				<expandproperties/>
			</filterchain>

			<fileset file="src/script/header.js" />
			<fileset file="src/user/annuus.user.js" />
		</concat>

		<!-- xpi -->
		<copy todir="${build_dir}" overwrite="true">
			<fileset dir="src" includes="xpi/" />
		</copy>

		<copy file="src/xpi/install.rdf" todir="${build_dir}/xpi" overwrite="true" encoding="UTF-8">
			<filterchain>
				<expandproperties/>
			</filterchain>
		</copy>

		<copy file="${build_dir}/annuus.js" todir="${build_dir}/xpi/content/" />

		<!-- m2f -->
		<copy todir="${build_dir}" overwrite="true">
			<fileset dir="src" includes="m2f/" />
		</copy>

		<copy file="src/m2f/Helianthus.annuus.xml" todir="${build_dir}/m2f" overwrite="true" encoding="UTF-8">
			<filterchain>
				<expandproperties/>
			</filterchain>
		</copy>

		<copy file="${build_dir}/annuus.js" todir="${build_dir}/m2f/Helianthus.annuus/Scripts" />

		<!-- crx -->
		<copy todir="${build_dir}" overwrite="true">
			<fileset dir="src" includes="crx/" />
		</copy>

		<copy file="src/crx/manifest.json" todir="${build_dir}/crx" overwrite="true" encoding="UTF-8">
			<filterchain>
				<expandproperties/>
			</filterchain>
		</copy>

		<copy file="${build_dir}/annuus.js" tofile="${build_dir}/crx/annuus.js" overwrite="true" />

		<!-- privoxy -->
		<copy todir="${build_dir}/privoxy" overwrite="true" encoding="UTF-8">
			<filterchain>
				<expandproperties/>
			</filterchain>

			<fileset dir="src/privoxy" includes="**/*" />
		</copy>
	</target>

	<target name="_dist">
		<!-- scripts -->
		<copy todir="${dist_dir}">
			<fileset dir="${build_dir}" includes="annuus.js" />
			<fileset dir="${build_dir}/user" includes="annuus.user.js" />
		</copy>

		<!-- crx -->
		<exec executable="cmd">
			<!-- http://github.com/Constellation/crxmake -->
			<arg value="/C crxmake --pack-extension=${build_dir}/crx --pack-extension-key=${key_path} --extension-out=${dist_dir}/annuus.crx" />
		</exec>

		<!-- xpi -->
		<mkdir dir="${build_dir}/xpi_package" />
		<mkdir dir="${build_dir}/xpi_package/chrome" />
		<zip destfile="${build_dir}/xpi_package/chrome/annuus.jar" basedir="${build_dir}/xpi" includes="content/*,locale/*,skin/*" />
		<copy todir="${build_dir}/xpi_package">
			<fileset dir="${build_dir}/xpi" includes="*/**" excludes="content/,locale/,skin/" />
		</copy>
		<replaceregexp file="${build_dir}/xpi_package/chrome.manifest" match=" (?=(?:content|locale|skin)/)" replace=" jar:chrome/annuus.jar!/" flags="g" encoding="UTF-8" />

		<zip destfile="${dist_dir}/annuus.xpi" basedir="${build_dir}/xpi_package" />

		<!-- m2f -->
		<zip destfile="${dist_dir}/annuus.m2f" basedir="${build_dir}/m2f" />

		<!-- privoxy -->
		<zip destfile="${dist_dir}/annuus.privoxy.zip" basedir="${build_dir}/privoxy" />
	</target>

	<target name="_clean">
		<delete failonerror="false">
			<fileset dir="${dist_dir}" includes="*/**" />
		</delete>
	</target>

	<target name="_stable">
		<property name="dist_dir" value="${dist_parent_dir}/stable" />
		<property name="AN_URL" value="http://helianthus-annuus.googlecode.com/svn/dist/v3/stable/annuus.js" />
	</target>

	<target name="_beta">
		<property name="dist_dir" value="${dist_parent_dir}/beta" />
		<property name="AN_URL" value="http://helianthus-annuus.googlecode.com/svn/dist/v3/beta/annuus.js" />
	</target>
</project>